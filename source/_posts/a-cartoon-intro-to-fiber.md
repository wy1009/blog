---
title: 对 Fiber 的卡通介绍
date: 2018-12-02 21:28:43
categories: [框架/库/工具, React.js]
tags: [JavaScript, React.js]
---

可能大多数人都不知道 Fiber 是什么。如果你不知道，不必担心，因为我会从最基本的开始。解释它是什么，以及它是如何工作的。

但在此之前，我想给你们展示它做了什么。这是一个 React app 的例子：

![React app 的例子](/images/fiber-react-app.gif "React app 的例子")

左边是现在的 React 的效果，右边是使用了 Fiber 的 React 的效果。这是一个玩具性质的应用，它本身不是很有用处，但却却可以很好地替代现实中的 app。我过会儿会解释原因。

那么，Fiber 做了什么？它为像上图这样的复杂 React 应用提升了用户感知的性能和响应。现在，你知道它做了什么，我将解释它是什么。

Fiber 是 React 新的协调算法。术语“协调算法”对一些人来说可能比较陌生，我来解释一下它的出处。

当 React 刚刚问世，杀手锏是虚拟 DOM，因为它使编写用户界面简单了许多。比起必须告诉浏览器从前一版本的 app 到后一版本该如何做，可以直接告诉 React，下一版本是什么样子的，React 就会处理中间的事。事实证明，这个不仅在处理 Dom 的时候有用，在处理其他方面的时候也很有用，比如硬件、虚拟现实、原生应用。

If we actually wanted to be able to address these use cases, though, I was going to have to factor out the part of React that figured out the changes from the previous version graph to the next version from the part that actually manipulated the Dom to get it there.（我实在不知道该如何对这句话断句，请路过的大大指教 QAQ）

![](/images/fiber-01.png)

这张图介绍了协调器和渲染器的正式区别。renderer 是可插拔的，so you can use renderer from outside from the rest of the community to target other host platforms besides the Dom. 但只有一个核心的协调算法。所以 Fiber 如此重要。过去几年，React 核心团队全面重写了这个核心特性——React的杀手锏，其结果就是 Fiber 协调器。

让我们回到这个 demo。

![React app 的例子](/images/fiber-react-app.gif "React app 的例子")

Fiber 调解器为什么能把左边这么卡顿的运动变得像右边这样流畅呢？我想先讲讲这个 demo 是怎么回事。这里面有两种不同的更新在进行，一种是使三角形变宽变窄，另一种是到每一个点里改变数字。这对于实际生活中的 app 是一个很好的替代，因为它使两种更新之间的相互作用可视化。这里存在高优先级的更新和低优先级的更新。举例子，高优先级的更新，是当你在打字的时候，你需要立即得到反馈回路。低优先级的更新，可能是当你从服务器取到值，更新类似一个评论的赞的数量。这个 demo 展示了高优先级更新和低优先级更新同时进行的时候，会发生什么。

那么，让我们谈谈这个例子的技术。你在最顶层有一个三角形：

![](/images/fiber02.png)

接着有更多的三角形：

![](/images/fiber03.png)
![](/images/fiber04.png)
![](/images/fiber05.png)

一直到最底层，会有一个点。

这些更新会接触到这棵树上不同的部分。变宽变窄的更新只能接触到顶层的三角形，所以它的计算量不是很大。但它发生得很频繁，它每 16ms 就要更新一次，这样才能给用户流畅的体验。另一方面，另一种更新计算量很大，因为它必须接触到这棵树上的每一个实例。这种更新一秒只发生一次，而且如果它不是立刻发生的，比如晚个一二百毫秒，你可能并不会注意到。

让我们按时间顺序来看。为了让外层的运动看起来流畅，我们需要每秒 60 帧，16ms 每帧。你可能觉得为了达到这个目的，需要 React 本身更快。但问题不是这种更新不能在 16ms 内完成，毕竟它只接触一个实例。实际上，它是正在被后面更大的更新卡住。大多数花费在这些更大更新上的时间，实际上都是花在了 render 函数和其他函数之类用户代码上，而不是 React 本身。所以让 React 本身更快不能快到解决这个问题。但有一种方法解决这个问题，是靠使更新更好地配合在一起。且不单是 React 更新需要配合得更好，也是从浏览器来的更新。那么，比如 CSS 动画，浏览器 resize，这些也会被上面大的更新卡在后面。

原因是浏览器工作的方式。当你在建立一个网站，有点像，你的代码是这个网站的项目领导，很不幸，只有一个雇员工作来建立这个网站，他就是主线程。所以，主线程有点像全站工程师，他做 DOM、JavaScript、布局……所有事。所以，只要他在花时间做 JavaScript 更新，它就不能做其他事，不能做布局。并且我之前讲过，当你使用 React，它是如何帮助的？它知道如何更好地和主线程一起工作吗？
它有些像一个技术领导，准确知道主线程是如何工作的。所以，它使主线程处理工作更高效，它可以依靠最小化和批量处理 DOM 变化来指导主线程工作。

fiber 做的基本就是教技术领导（React）一些基本的项目管理技巧，比如如何切分工作，如何划分工作优先级。同时，它还能让技术领导一直追踪过去了多少时间。那么，这些新技能是如何参与进来的呢？他们是如何改变协调器的工作方式的呢？让我们先看看目前存在的协调器是如何工作的吧。
